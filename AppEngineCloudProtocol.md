

# Introduction #

FindBugs now has the option to use a web service to store bug information and evaluations/comments among users of a Java project. This is implemented on the client side in:
  * Client: [trunk/sandbox/appEngineCloudClient](http://code.google.com/p/findbugs/source/browse/#svn/trunk/sandbox/appEngineCloudClient)
  * Server: [trunk/sandbox/appEngineCloud](http://code.google.com/p/findbugs/source/browse/#svn/trunk/sandbox/appEngineCloud).

## Notes on this document ##

All URL's mentioned in this document should be taken to be prefixed with http://theflybush.appspot.com - for example, the URL `/find-issues` refers to `http://theflybush.appspot.com/find-issues`

Timestamps in this protocol are all stored in milliseconds since the Unix epoch, in UTC time.

# Authorization #

Most cloud commands require a registered session ID. The session ID is generated by the client, as a signed 64-bit integer (stored as a `long` in Java). The ID is registered with the server via opening the user's web browser to the URL:

> /browser-auth/<em>sessionID</em>

This will redirect the user to a Google Accounts sign-in page. In the meantime, the client must periodically poll the server to see when the user has successfully signed in. This is done by requesting:

> GET /check-auth/<em>sessionID</em>

This command will return HTTP status code 418 until the user has successfully signed in, at which point it will return status code 200 with the following `text/plain` output:

> OK<br>
<blockquote><em>sessionID</em><br>
<em>userID</em></blockquote>

<code>userID</code> will be the user's application-wide user ID. It may be the user's e-mail address (like <i>bob@gmail.com</i>) or just a Google Account username (like <i>bob</i>).<br>
<br>
To log out and deactivate a session ID, run:<br>
<br>
<blockquote>POST /log-out/<em>sessionID</em></blockquote>

<h1>Issue sync</h1>

<h2>Google Protocol Buffers</h2>

The protocol is simply Google Protocol Buffer objects sent and received as HTTP requests. See <a href='http://code.google.com/p/findbugs/source/browse/trunk/sandbox/appEngineCloudProtocol/src/java/ProtoClasses.proto'>ProtoClasses.proto</a> for details on the protocol.<br>
<br>
Two data structures are used in the protocol, one for a bug instance (<code>Issue</code>) and one for its user evaluations (<code>Evaluation</code>).<br>
<br>
Bug instance hashes are stored in binary in big-endian two's-complement format.<br>
<br>
<pre><code><br>
message Issue {<br>
optional bytes hash = 1;<br>
optional string bugPattern = 2;<br>
optional int32 priority = 3;<br>
optional string primaryClass = 4;<br>
optional int64 firstSeen = 5;<br>
optional int64 lastSeen = 6;<br>
optional string bugLink = 8;<br>
repeated Evaluation evaluations = 7;<br>
}<br>
</code></pre>

The issue structure contains:<br>
<br>
<table><thead><th> <b>Field</b> </th><th> <b>Description</b> </th><th> <b>Example</b> </th></thead><tbody>
<tr><td> hash         </td><td> the bug's instance hash (a 32-character hex ASCII MD5 hash) </td><td> a5ad6e71dbae86b448035032f8f07ee4 </td></tr>
<tr><td> bugPattern   </td><td> the bug pattern abbreviation </td><td> <code>NP_UNWRITTEN_FIELD</code> </td></tr>
<tr><td> priority     </td><td> 1-3                </td><td> 2              </td></tr>
<tr><td> primaryClass </td><td> the class where the bug occurred </td><td> <code>edu.umd.findbugs.BuggyClass</code> </td></tr>
<tr><td> firstSeen    </td><td> date when the bug was first seen </td></tr>
<tr><td> lastSeen     </td><td> date when the bug was last seen </td></tr>
<tr><td> evaluations  </td><td> a list of evaluations for this issue </td></tr></tbody></table>

The data structure for evaluations is as follows:<br>
<br>
<pre><code><br>
message Evaluation {<br>
optional string who = 1;<br>
optional string designation = 2;<br>
optional string comment = 3;<br>
optional int64 when = 4;<br>
}<br>
</code></pre>


The issue structure contains:<br>
<br>
<table><thead><th> <b>Field</b> </th><th> <b>Description</b> </th><th> <b>Example</b> </th></thead><tbody>
<tr><td> who          </td><td> username or email of the person who made this evaluation </td><td> bob@gmail.com  </td></tr>
<tr><td> designation  </td><td> a designation      </td><td> MOSTLY_HARMLESS </td></tr>
<tr><td> comment      </td><td> a text comment     </td></tr>
<tr><td> when         </td><td> a timestamp of when this comment was made </td></tr></tbody></table>


<h2>Initial sync with the server</h2>

After authenticating, the client sends a <code>LogIn</code> command. This command contains the authenticated session ID, a timestamp of when the user's FindBugs analysis was run, and a list of FindBugs bug instance hashes (MD5 hashes in hex ASCII format).<br>
<br>
<pre><code><br>
message LogIn {<br>
required int64 sessionId = 1;<br>
required int64 analysisTimestamp = 3;<br>
}<br>
</code></pre>

The command is sent over HTTP with the request:<br>
<br>
<blockquote>POST /log-in</blockquote>

The <code>LogIn</code> message is included in binary format as the POST contents. If the request succeeds, the server will return status code 200.<br>
<br>
The client then sends a {{{FindIssues}}:<br>
<br>
<pre><code><br>
message FindIssues {<br>
required int64 sessionId = 1;<br>
repeated bytes myIssueHashes = 4;<br>
}<br>
</code></pre>

Again, hashes are encoded as big-endian two's complement byte strings. The server will respond with status code 200 and a <code>FindIssuesResponse</code>.<br>
<br>
<pre><code><br>
message FindIssuesResponse {<br>
repeated Issue foundIssues = 1;<br>
}<br>
</code></pre>

The response contains a list of issues, the same number and in the same order as the hashes sent in the <code>FindIssues</code>. Issues which are already on the cloud contain the <code>firstSeen</code>, <code>lastSeen</code>, <code>bugLink</code>, and <code>evaluations</code>. Issues which are not known by the cloud are simply empty, and these should be uploaded as described in the next section.<br>
<br>
<h2>Uploading issues</h2>

The <code>FindIssuesResponse </code> contains a list of issues which the server knows about. All other issues in the client's analysis, which are not known by the server, should be uploaded with an <code>UploadIssues</code> command. Again, the command is included as the contents of an HTTP POST request:<br>
<br>
<blockquote>POST /upload-issues</blockquote>

<pre><code><br>
message UploadIssues {<br>
required int64 sessionId = 1;<br>
repeated Issue newIssues = 2;<br>
}<br>
</code></pre>

The issues may contain a list of evaluations made by the user. Upon success, this request will return a HTTP 200 status code.<br>
<br>
<h1>Issue properties</h1>

Evaluations are the core feature of the FindBugs cloud. Evaluations are a way of sharing per-bug commentary among members of a project.<br>
<br>
<h2>Uploading evaluations</h2>

Aside from being uploaded as part of the <code>UploadIssues</code> command described above, an individual evaluation for a bug can be uploaded via the <code>UploadEvaluation</code> command. This contains an authenticated session ID, the FindBugs instance hash of the bug being evaluated, and the evaluation itself.<br>
<br>
<blockquote>POST /upload-evaluation</blockquote>

<pre><code><br>
message UploadEvaluation {<br>
required int64 sessionId = 1;<br>
required string hash = 2;<br>
required Evaluation evaluation = 3;<br>
}<br>
</code></pre>

Upon success, the server will return HTTP status code 200.<br>
<br>
<h2>Checking for new evaluations</h2>

While the user of the client application is browsing bugs, the client can check the server to see if any updates have been made. This is done via a <code>GetRecentEvaluations</code> command. This command contains an authenticated session ID as well as a timestamp. The timestamp should be that of the most recent user evaluation that the client has seen.<br>
<br>
<blockquote>POST /get-recent-evaluations</blockquote>

<pre><code><br>
message GetRecentEvaluations {<br>
required int64 sessionId = 1;<br>
required int64 timestamp = 2;<br>
}<br>
</code></pre>

The server will respond with HTTP status code 200, and a list of <i>all</i> evaluations of <i>all</i> bugs which have been uploaded since the given timestamp:<br>
<br>
<pre><code><br>
message RecentEvaluations {<br>
repeated Issue issues = 1;<br>
}<br>
</code></pre>

<h2>Associating an issue with a bug tracker link</h2>

Issues can contain a link to a website where the issue is being tracked and commented on.<br>
<br>
<blockquote>POST /set-bug-link</blockquote>

<pre><code><br>
message SetBugLink {<br>
required int64 sessionId = 1;<br>
required bytes hash = 2;<br>
optional string url = 3;<br>
}<br>
</code></pre>

Upon success, the server will respond with a HTTP status code 200.